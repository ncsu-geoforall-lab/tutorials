<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.551">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Veronica Andreo">

<title>Time series gap filling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">GRASS Tutorials</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
    <div class="dropdown">
      <a href="" title="" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label=""><i class="bi bi-github"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/ncsu-geoforall-lab/tutorials">
            Source Code
            </a>
          </li>
          <li>
            <a class="dropdown-item quarto-navbar-tools-item" href="https://github.com/ncsu-geoforall-lab/tutorials/issues">
            Report an Issue
            </a>
          </li>
      </ul>
    </div>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of Contents</h2>
   
  <ul>
  <li><a href="#full-maps-missing" id="toc-full-maps-missing" class="nav-link active" data-scroll-target="#full-maps-missing">Full maps missing</a></li>
  <li><a href="#maps-with-holes" id="toc-maps-with-holes" class="nav-link" data-scroll-target="#maps-with-holes">Maps with holes</a>
  <ul class="collapse">
  <li><a href="#simulating-the-holes" id="toc-simulating-the-holes" class="nav-link" data-scroll-target="#simulating-the-holes">Simulating the holes</a></li>
  <li><a href="#filling-the-holes" id="toc-filling-the-holes" class="nav-link" data-scroll-target="#filling-the-holes">Filling the holes</a></li>
  <li><a href="#comparison-of-r.hants-and-r.series.lwr-results" id="toc-comparison-of-r.hants-and-r.series.lwr-results" class="nav-link" data-scroll-target="#comparison-of-r.hants-and-r.series.lwr-results">Comparison of r.hants and r.series.lwr results</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Time series gap filling</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
  <div class="quarto-categories">
    <div class="quarto-category">GRASS GIS</div>
    <div class="quarto-category">Time series</div>
    <div class="quarto-category">raster</div>
    <div class="quarto-category">Advanced</div>
    <div class="quarto-category">Python</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Veronica Andreo </p>
          </div>
  </div>
    
  
    <div>
    <div class="quarto-title-meta-heading">Modified</div>
    <div class="quarto-title-meta-contents">
      <p class="date-modified">August 29, 2024</p>
    </div>
  </div>
    
  </div>
  


</header>


<p>In this fifth part of the time series tutorials, we will go through an important topic when working with optic remote sensing derived data or products: gaps and gap filling. There are several other methods to perform missing data imputation. Here, we’ll only demonstrate the usage of GRASS GIS tools that allow us to perform gap filling in time, also called temporal interpolation. Specifically, we’ll show how to reconstruct missing data using:</p>
<ul>
<li><a href="https://grass.osgeo.org/grass-stable/manuals/t.rast.gapfill.html">t.rast.gapfill</a>,</li>
<li><a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html">r.hants</a>, and</li>
<li><a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html">r.series.lwr</a>.</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled" title="Setup">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Setup
</div>
</div>
<div class="callout-body-container callout-body">
<p>This tutorial can be run locally or in Google Colab. However, make sure you install GRASS GIS 8.4+, download the LST sample data and set up your project as explained in the <a href="../time_series/time_series_management_and_visualization.html">first part</a> of these time series tutorials.</p>
</div>
</div>
<p>There are different types of gaps that we might want/need to fill when working with time series data: - full maps missing, e.g.&nbsp;a daily time series where some days are missing because product tiles missing from the archive, or when we want to interpolate from weekly to daily data - series is complete but (some) maps have missing data because of clouds, snow, product quality flags applied, etc.</p>
<section id="full-maps-missing" class="level2">
<h2 class="anchored" data-anchor-id="full-maps-missing">Full maps missing</h2>
<p>For the case of full maps missing, GRASS GIS offers simple linear interpolation in time through the <a href="https://grass.osgeo.org/grass-stable/manuals/t.rast.gapfill.html">t.rast.gapfill</a> tool. Let’s see an example: we will first aggregate our daily LST time series with a monthly granularity, then make a copy of it using <a href="https://grass.osgeo.org/grass-stable/manuals/t.copy.html">t.copy</a>, unregister a couple of maps here and there with <a href="https://grass.osgeo.org/grass-stable/manuals/t.unregister.html">t.unregister</a>, apply a temporal linear interpolation with <em>t.rast.gapfill</em> and compare the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily time series into monthly</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.aggregate"</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_daily"</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly"</span>, </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>               basename<span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>               method<span class="op">=</span><span class="st">"average"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>               granularity<span class="op">=</span><span class="st">"1 months"</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>               suffix<span class="op">=</span><span class="st">"gran"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a copy</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.copy"</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly_copy"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Unregister maps from lst_monthly_copy</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that we remove 1, 2 and 3 consecutive maps in different periods of the year</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>to_unregister<span class="op">=</span>[lst_monthly_2014_03,lst_monthly_2014_10,lst_monthly_2014_11,lst_monthly_2015_06,lst_monthly_2015_07,lst_monthly_2015_08]</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.unregister"</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>               maps<span class="op">=</span>to_unregister)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check gaps</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>gs.read_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>                <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>, </span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>                method<span class="op">=</span><span class="st">"deltagaps"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill gaps</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.gapfill"</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>               basename<span class="op">=</span><span class="st">"gaps"</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check gaps again and compare values with lst_monthly</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>               columns<span class="op">=</span><span class="st">"name,start_time,min,max"</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>               where<span class="op">=</span><span class="st">"start_time &lt; '2016-01-01'"</span>)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>               columns<span class="op">=</span><span class="st">"name,start_time,min,max"</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>               where<span class="op">=</span><span class="st">"start_time &lt; '2016-01-01'"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the two time series for the city of Trento</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>g.gui.tplot strds<span class="op">=</span>lst_monthly,lst_monthly_copy <span class="op">\</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  coordinates<span class="op">=</span><span class="fl">4410837.455830389</span>,<span class="fl">2559852.473498233</span> <span class="op">\</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  title<span class="op">=</span><span class="st">"Trento daily LST"</span> xlabel<span class="op">=</span><span class="st">"Time"</span> ylabel<span class="op">=</span><span class="st">"LST (C)"</span> \</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  size<span class="op">=</span><span class="dv">800</span>,<span class="dv">500</span> output<span class="op">=</span>trento_gapfilled.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/trento_gapfilled.png" class="img-fluid figure-img"></p>
<figcaption>Linear interpolation of LST time series</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="https://grass.osgeo.org/grass-stable/manuals/t.unregister.html">t.unregister</a> allows us to remove maps from the temporal database or from a STRDS without actually removing them from the mapset, i.e., we only remove their timestamp and hence their record in the STRDS object.</p>
</div>
</div>
</section>
<section id="maps-with-holes" class="level2">
<h2 class="anchored" data-anchor-id="maps-with-holes">Maps with holes</h2>
<p>For the case when maps have no data areas (i.e.&nbsp;holes or gaps) because of cloud or cloud shadow masking, or as a result of QA flags application, two GRASS tools can be used, namely <a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html">r.hants</a> or <a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html">r.series.lwr</a>. When to use one or the other will mostly depend on the variable that the time series represent (i.e., temperature, NDVI, chlorophyll, etc.) and its granularity (i.e., hourly, daily, weekly, monthly, etc.).</p>
<section id="simulating-the-holes" class="level3">
<h3 class="anchored" data-anchor-id="simulating-the-holes">Simulating the holes</h3>
<p>To demonstrate the use of r.hants and r.series.lwr with our LST time series, we will simulate the occurrence of clouds by randomly masking different provinces in our study area. This will be a very simplified case only for demonstration purposes. A proper example of how to mask clouds and apply quality assessment flags will be developed in a different series of tutorials.</p>
<p>We clip the provinces vector map with the computational region in order to get the list of polygons’ ids or cat values, that we’ll use as <em>“clouds”</em>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Clip Italy provinces to the comp region</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"v.clip"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"italy_borders_2"</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"italy_borders_2_clip"</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>               flags<span class="op">=</span><span class="st">"r"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique categories </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>cats <span class="op">=</span> gs.parse_command(<span class="st">"v.category"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">input</span><span class="op">=</span><span class="st">"italy_borders_2_clip"</span>, </span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                        option<span class="op">=</span><span class="st">"print"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>cats <span class="op">=</span> <span class="bu">list</span>(cats.keys())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we list the maps over which we will create the gaps.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get list of monthly maps</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>maps <span class="op">=</span> gs.parse_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                         <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                         columns<span class="op">=</span><span class="st">"name"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                         method<span class="op">=</span><span class="st">"comma"</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                         flags<span class="op">=</span><span class="st">"u"</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>maps <span class="op">=</span> <span class="bu">list</span>(maps.keys())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we actually use 4 random polygons to create holes in each map of the monthly LST time series. Basically, for each map of the series, we apply an inverse mask of 4 random polygons, we overwrite the maps to actually get the holes (i.e., <em>MASK</em> is otherwise virtual), and we remove the mask.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>n<span class="op">=</span><span class="dv">4</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(maps)):</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    gs.run_command(<span class="st">"r.mask"</span>, </span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                   vector<span class="op">=</span><span class="st">"italy_borders_2_clip"</span>, </span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                   cats<span class="op">=</span>random.sample(cats,n), </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                   flags<span class="op">=</span><span class="st">"i"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    gs.mapcalc(exp<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>maps[i]<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>maps[i]<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>               overwrite<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    gs.run_command(<span class="st">"r.mask"</span>, </span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>                   flags<span class="op">=</span><span class="st">"r"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s check the holes we created</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gaps <span class="op">=</span> gj.Map(height <span class="op">=</span> <span class="dv">500</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>gaps.d_rast(<span class="bu">map</span><span class="op">=</span><span class="st">"lst_monthly_2017_01"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>gaps.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="filling-the-holes" class="level3">
<h3 class="anchored" data-anchor-id="filling-the-holes">Filling the holes</h3>
<section id="harmonic-analysis-of-time-series" class="level4">
<h4 class="anchored" data-anchor-id="harmonic-analysis-of-time-series">Harmonic analysis of time series</h4>
<p><a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html">r.hants</a> performs a <strong>Harmonic ANalysis of Time Series (HANTS)</strong> analysis in order to estimate missing values and identify outliers. This algorithm considers only the most significant frequencies expected to be present in the time profiles (e.g.&nbsp;determined from a preceding Fast Fourier Transform analysis), and applies a least squares curve fitting procedure based on harmonic components (sines and cosines).</p>
<p>The option <code>nf</code>, number of frequencies, should be carefully chosen. As a rule of thumb, the nf should be at least the estimated periodicity plus 3, e.g.&nbsp;for NDVI with an annual cycle (one peak per year), the number of frequencies should be at least 4 when analyzing one year. The number of frequencies should not be too large, either. Otherwise, outliers can no longer be identified because of overfitting. Moreover, the number of frequencies should be smaller than n input maps / 2 if missing values should be reconstructed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install extension</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"g.extension"</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>               extension<span class="op">=</span><span class="st">"r.hants"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic usage of r.hants</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"r.hants"</span>,</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span>maps,</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>               nf<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>               base_period<span class="op">=</span><span class="dv">12</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout-notes">
<p>Other <em>r.hants</em> options and flags that can be used to adjust the fit can be found at the tool manual page: <a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html" class="uri">https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html</a> and also within the <a href="https://www.tandfonline.com/doi/abs/10.1080/014311600209814">original publication</a>.</p>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List filled maps</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>hants_maps <span class="op">=</span> gs.list_grouped(<span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                             pattern<span class="op">=</span><span class="st">"*hants"</span>)[<span class="st">"italy_LST_daily"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ccreate new time series </span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.create"</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly_hants"</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"strds"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>               temporaltype<span class="op">=</span><span class="st">"absolute"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>               title<span class="op">=</span><span class="st">"Gap-filled monthly LST"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>               description<span class="op">=</span><span class="st">"HANTS gap-filled monthly LST - North Italy, 2014-2018"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># register maps</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.register"</span>,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>               flags<span class="op">=</span><span class="st">"i"</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_hants"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>               maps<span class="op">=</span>hants_maps,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>               start<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>               increment<span class="op">=</span><span class="st">"1 months"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print time series info</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gs.read_command(<span class="st">"t.info"</span>, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_hants"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s see a plot.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>g.gui.tplot strds<span class="op">=</span>lst_monthly_hants,lst_monthly <span class="op">\</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  coordinates<span class="op">=</span><span class="fl">4410837.455830389</span>,<span class="fl">2559852.473498233</span> <span class="op">\</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  title<span class="op">=</span><span class="st">"Trento reconstructed LST"</span> xlabel<span class="op">=</span><span class="st">"Time"</span> ylabel<span class="op">=</span><span class="st">"LST (C)"</span> \</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  size<span class="op">=</span><span class="dv">800</span>,<span class="dv">500</span> output<span class="op">=</span>trento_hants.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/trento_hants.png" class="img-fluid figure-img"></p>
<figcaption>HANTS interpolation of LST time series</figcaption>
</figure>
</div>
<p>Something important to highlight is that <em>r.hants</em> will fit a single model to the whole input time series. For multiple years, that might not be the best option because there won’t be any variation. So, for the case of multiple years, it is recommended to do multiple runs and then temporally patch the results.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><em>r.hants</em> will reconstruct all cells within the input maps, whether they have gaps or not. If we want to keep the original values, we could patch the original series with the reconstructed result. That could be done as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Patching</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,j <span class="kw">in</span> <span class="bu">zip</span>(maps,hants_maps):</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(i, j)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    out<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">_patch"</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    gs.run_command(<span class="st">"r.patch"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>                   <span class="bu">input</span><span class="op">=</span>[i, j],</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>                   output<span class="op">=</span>out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</div>
</section>
<section id="local-weighted-regression" class="level4">
<h4 class="anchored" data-anchor-id="local-weighted-regression">Local weighted regression</h4>
<p><a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html">r.series.lwr</a> performs a local weighted regression (LWR) in time in order to estimate missing values and identify outliers. For each observation in the time series, the neighbor values in time are used to estimate a polynomial function that best fits the observations. The values are weighted according to their distance in time to the current observation. Values that are farther away get lower weights. The difference among the weight functions lies in how strongly the current observation is emphasized with respect to its temporal neighbors.</p>
<p>The option order determines the order of the polynomial function used to fit the observations. An order of 0 is a weighted average, an order of 1 is a linear regression. Recommended is order=2.</p>
<p>All gaps in the time series are by default interpolated, as long as the time series contains sufficient non-NULL observations. Optionally, the maximum size of gaps to be interpolated can be set with the maxgap option.</p>
<p>The module uses an adaptive bandwidth to fit the polynomial and searches for: order + 1 + dod valid values around the current observation. The degree of over-determination (dod) is the user defined number of extra temporal neighbors that should be considered for the estimation of the value at each time step.</p>
<p>Just for comparison purposes, we’ll use the <code>lst_monthly</code> time series. However, r.series.lwr is known to be more effective when there’s no such a clear cyclic pattern or in smaller granularities, like daily or weekly, when data shows more variation.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install extension</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"g.extension"</span>,</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>               extension<span class="op">=</span><span class="st">"r.series.lwr"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run r.series.lwr</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"r.series.lwr"</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>                <span class="bu">input</span><span class="op">=</span>maps,</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>                suffix<span class="op">=</span><span class="st">"_lwr"</span>,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                order<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span><span class="st">"tricube"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Other <em>r.series.lwr</em> options and flags that can be used to adjust the fit can be found at the tool manual page: <a href="https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html" class="uri">https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html</a>.</p>
</div>
</div>
<p>Let’s create a time series and plot the results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># List filled maps</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>lwr_maps <span class="op">=</span> gs.list_grouped(<span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                           pattern<span class="op">=</span><span class="st">"*lwr"</span>)[<span class="st">"italy_LST_daily"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ccreate new time series </span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.create"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly_lwr"</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"strds"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>               temporaltype<span class="op">=</span><span class="st">"absolute"</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>               title<span class="op">=</span><span class="st">"Gap-filled monthly LST"</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>               description<span class="op">=</span><span class="st">"LWR gap-filled monthly LST - North Italy, 2014-2018"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># register maps</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.register"</span>,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>               flags<span class="op">=</span><span class="st">"i"</span>,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_lwr"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>               maps<span class="op">=</span>lwr_maps,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>               start<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>               increment<span class="op">=</span><span class="st">"1 months"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Print time series info</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gs.read_command(<span class="st">"t.info"</span>, </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_hants"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>g.gui.tplot strds<span class="op">=</span>lst_monthly_lwr,lst_monthly <span class="op">\</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  coordinates<span class="op">=</span><span class="fl">4410837.455830389</span>,<span class="fl">2559852.473498233</span> <span class="op">\</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  title<span class="op">=</span><span class="st">"Trento reconstructed LST"</span> xlabel<span class="op">=</span><span class="st">"Time"</span> ylabel<span class="op">=</span><span class="st">"LST (C)"</span> \</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  size<span class="op">=</span><span class="dv">800</span>,<span class="dv">500</span> output<span class="op">=</span>trento_lwr.png</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/trento_lwr.png" class="img-fluid figure-img"></p>
<figcaption>LWR interpolation of LST time series</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that there’s an overshoot towards negative values because of missing data in the first date. Extrapolation can be avoided by using the <code>i</code> flag for <em>interpolation only</em>.</p>
</div>
</div>
</section>
</section>
<section id="comparison-of-r.hants-and-r.series.lwr-results" class="level3">
<h3 class="anchored" data-anchor-id="comparison-of-r.hants-and-r.series.lwr-results">Comparison of r.hants and r.series.lwr results</h3>
<p>There are not so significant differences among the results of these two reconstructing methods, probably because it is a smoothed time series. But have a look at a comparison of applying HANTS and LWR to a Chlorophyll-a time series with 8-day granularity:</p>
<p><img src="https://grasswiki.osgeo.org/w/images/Cla_vs_cla_hants.png" class="img-fluid" style="width:80.0%" alt="Chlorophyll data reconstruction with HANTS"> <img src="https://grasswiki.osgeo.org/w/images/Cla_vs_cla_lwr.png" class="img-fluid" style="width:80.0%" alt="Chlorophyll data reconstruction with LWR"></p>
<p>More details can be found in the <a href="https://grasswiki.osgeo.org/wiki/Temporal_data_processing#Filling_and_reconstructing_time_series_data_with_gaps">Filling and Reconstructing time series</a> of the temporal data processing wiki page.</p>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li>Roerink, G., Menenti, M., Verhoef, W. 2000. <em>Reconstructing cloudfree NDVI composites using Fourier analysis of time series.</em> International Journal of Remote Sensing, 21 (9), 1911-1917. <a href="http://dx.doi.org/10.1080/014311600209814">DOI</a>.</li>
<li>Gebbert, S., Pebesma, E. 2014. <em>TGRASS: A temporal GIS for field based environmental modeling.</em> Environmental Modelling &amp; Software 53, 1-12. <a href="http://dx.doi.org/10.1016/j.envsoft.2013.11.001">DOI</a>.</li>
<li>Gebbert, S., Pebesma, E. 2017. <em>The GRASS GIS temporal framework.</em> International Journal of Geographical Information Science 31, 1273-1292. <a href="http://dx.doi.org/10.1080/13658816.2017.1306862">DOI</a>.</li>
<li><a href="https://grasswiki.osgeo.org/wiki/Temporal_data_processing">Temporal data processing</a> wiki page.</li>
</ul>
<hr>
<div class="smaller">
<p>The development of this tutorial was funded by the US <a href="https://www.nsf.gov/">National Science Foundation (NSF)</a>, award <a href="https://www.nsf.gov/awardsearch/showAward?AWD_ID=2303651">2303651</a>.</p>
</div>


<!-- -->

</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb24" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Time series gap filling"</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> "Veronica Andreo"</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="an">date-modified:</span><span class="co"> today</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-copy: true</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: false</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="an">categories:</span><span class="co"> [GRASS GIS, Time series, raster, Advanced, Python]</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="an">engine:</span><span class="co"> knitr</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co">  eval: false</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="an">jupyter:</span><span class="co"> python3</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>In this fifth part of the time series tutorials, we will go through an important </span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a>topic when working with optic remote sensing derived data or products: gaps and</span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>gap filling. There are several other methods to perform missing data imputation.</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>Here, we'll only demonstrate the usage of GRASS GIS tools that allow us to</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>perform gap filling in time, also called temporal interpolation. </span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>Specifically, we'll show how to reconstruct missing data using:</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">t.rast.gapfill</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/t.rast.gapfill.html)</span>, </span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">r.hants</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html)</span>, and</span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">r.series.lwr</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html)</span>.</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a>::: {.callout-note title="Setup"}</span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>This tutorial can be run locally or in Google Colab. However, make sure you</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>install GRASS GIS 8.4+, download the LST sample data and set up your project</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a>as explained in the <span class="co">[</span><span class="ot">first part</span><span class="co">](time_series_management_and_visualization.qmd)</span> </span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a>of these time series tutorials.</span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="co"># GRASS GIS database variables</span></span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a>grassbin <span class="op">=</span> <span class="st">"grass-dev"</span></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a>grassdata <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">'~'</span>), <span class="st">"grassdata"</span>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> <span class="st">"eu_laea"</span></span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a>mapset <span class="op">=</span> <span class="st">"italy_LST_daily"</span></span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a>sys.path.append(</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    subprocess.check_output([grassbin, <span class="st">"--config"</span>, <span class="st">"python_path"</span>], text<span class="op">=</span><span class="va">True</span>).strip()</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-56"><a href="#cb24-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-59"><a href="#cb24-59" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-60"><a href="#cb24-60" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb24-61"><a href="#cb24-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-62"><a href="#cb24-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Import the GRASS GIS packages we need</span></span>
<span id="cb24-63"><a href="#cb24-63" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> grass.script <span class="im">as</span> gs</span>
<span id="cb24-64"><a href="#cb24-64" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> grass.jupyter <span class="im">as</span> gj</span>
<span id="cb24-65"><a href="#cb24-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-66"><a href="#cb24-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the GRASS GIS Session</span></span>
<span id="cb24-67"><a href="#cb24-67" aria-hidden="true" tabindex="-1"></a>session <span class="op">=</span> gj.init(grassdata, project, mapset)<span class="op">;</span></span>
<span id="cb24-68"><a href="#cb24-68" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-69"><a href="#cb24-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-70"><a href="#cb24-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-71"><a href="#cb24-71" aria-hidden="true" tabindex="-1"></a>There are different types of gaps that we might want/need to fill when working</span>
<span id="cb24-72"><a href="#cb24-72" aria-hidden="true" tabindex="-1"></a>with time series data: </span>
<span id="cb24-73"><a href="#cb24-73" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>full maps missing, e.g. a daily time series where some days are missing because product tiles missing from the archive, or when we want to interpolate from weekly to daily data</span>
<span id="cb24-74"><a href="#cb24-74" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>series is complete but (some) maps have missing data because of clouds, snow, product quality flags applied, etc.</span>
<span id="cb24-75"><a href="#cb24-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-76"><a href="#cb24-76" aria-hidden="true" tabindex="-1"></a><span class="fu">## Full maps missing</span></span>
<span id="cb24-77"><a href="#cb24-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-78"><a href="#cb24-78" aria-hidden="true" tabindex="-1"></a>For the case of full maps missing, GRASS GIS offers simple linear interpolation</span>
<span id="cb24-79"><a href="#cb24-79" aria-hidden="true" tabindex="-1"></a>in time through the </span>
<span id="cb24-80"><a href="#cb24-80" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">t.rast.gapfill</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/t.rast.gapfill.html)</span> </span>
<span id="cb24-81"><a href="#cb24-81" aria-hidden="true" tabindex="-1"></a>tool. Let's see an example: we will first aggregate our daily LST time series</span>
<span id="cb24-82"><a href="#cb24-82" aria-hidden="true" tabindex="-1"></a>with a monthly granularity, then make a copy of it using</span>
<span id="cb24-83"><a href="#cb24-83" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">t.copy</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/t.copy.html)</span>, </span>
<span id="cb24-84"><a href="#cb24-84" aria-hidden="true" tabindex="-1"></a>unregister a couple of maps here and there with</span>
<span id="cb24-85"><a href="#cb24-85" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">t.unregister</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/t.unregister.html)</span>, </span>
<span id="cb24-86"><a href="#cb24-86" aria-hidden="true" tabindex="-1"></a>apply a temporal linear interpolation with *t.rast.gapfill* and compare</span>
<span id="cb24-87"><a href="#cb24-87" aria-hidden="true" tabindex="-1"></a>the results.</span>
<span id="cb24-88"><a href="#cb24-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-91"><a href="#cb24-91" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-92"><a href="#cb24-92" aria-hidden="true" tabindex="-1"></a><span class="co"># Aggregate daily time series into monthly</span></span>
<span id="cb24-93"><a href="#cb24-93" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.aggregate"</span>,</span>
<span id="cb24-94"><a href="#cb24-94" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_daily"</span>,</span>
<span id="cb24-95"><a href="#cb24-95" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly"</span>, </span>
<span id="cb24-96"><a href="#cb24-96" aria-hidden="true" tabindex="-1"></a>               basename<span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb24-97"><a href="#cb24-97" aria-hidden="true" tabindex="-1"></a>               method<span class="op">=</span><span class="st">"average"</span>,</span>
<span id="cb24-98"><a href="#cb24-98" aria-hidden="true" tabindex="-1"></a>               granularity<span class="op">=</span><span class="st">"1 months"</span>,</span>
<span id="cb24-99"><a href="#cb24-99" aria-hidden="true" tabindex="-1"></a>               suffix<span class="op">=</span><span class="st">"gran"</span>)</span>
<span id="cb24-100"><a href="#cb24-100" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-101"><a href="#cb24-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-104"><a href="#cb24-104" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-105"><a href="#cb24-105" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a copy</span></span>
<span id="cb24-106"><a href="#cb24-106" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.copy"</span>,</span>
<span id="cb24-107"><a href="#cb24-107" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb24-108"><a href="#cb24-108" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly_copy"</span>)</span>
<span id="cb24-109"><a href="#cb24-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-110"><a href="#cb24-110" aria-hidden="true" tabindex="-1"></a><span class="co"># Unregister maps from lst_monthly_copy</span></span>
<span id="cb24-111"><a href="#cb24-111" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that we remove 1, 2 and 3 consecutive maps in different periods of the year</span></span>
<span id="cb24-112"><a href="#cb24-112" aria-hidden="true" tabindex="-1"></a>to_unregister<span class="op">=</span>[lst_monthly_2014_03,lst_monthly_2014_10,lst_monthly_2014_11,lst_monthly_2015_06,lst_monthly_2015_07,lst_monthly_2015_08]</span>
<span id="cb24-113"><a href="#cb24-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-114"><a href="#cb24-114" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.unregister"</span>,</span>
<span id="cb24-115"><a href="#cb24-115" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>,</span>
<span id="cb24-116"><a href="#cb24-116" aria-hidden="true" tabindex="-1"></a>               maps<span class="op">=</span>to_unregister)</span>
<span id="cb24-117"><a href="#cb24-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-118"><a href="#cb24-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Check gaps</span></span>
<span id="cb24-119"><a href="#cb24-119" aria-hidden="true" tabindex="-1"></a>gs.read_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb24-120"><a href="#cb24-120" aria-hidden="true" tabindex="-1"></a>                <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>, </span>
<span id="cb24-121"><a href="#cb24-121" aria-hidden="true" tabindex="-1"></a>                method<span class="op">=</span><span class="st">"deltagaps"</span>)</span>
<span id="cb24-122"><a href="#cb24-122" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-123"><a href="#cb24-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-126"><a href="#cb24-126" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-127"><a href="#cb24-127" aria-hidden="true" tabindex="-1"></a><span class="co"># Fill gaps</span></span>
<span id="cb24-128"><a href="#cb24-128" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.gapfill"</span>,</span>
<span id="cb24-129"><a href="#cb24-129" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>,</span>
<span id="cb24-130"><a href="#cb24-130" aria-hidden="true" tabindex="-1"></a>               basename<span class="op">=</span><span class="st">"gaps"</span>)</span>
<span id="cb24-131"><a href="#cb24-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-132"><a href="#cb24-132" aria-hidden="true" tabindex="-1"></a><span class="co"># Check gaps again and compare values with lst_monthly</span></span>
<span id="cb24-133"><a href="#cb24-133" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb24-134"><a href="#cb24-134" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_copy"</span>,</span>
<span id="cb24-135"><a href="#cb24-135" aria-hidden="true" tabindex="-1"></a>               columns<span class="op">=</span><span class="st">"name,start_time,min,max"</span>,</span>
<span id="cb24-136"><a href="#cb24-136" aria-hidden="true" tabindex="-1"></a>               where<span class="op">=</span><span class="st">"start_time &lt; '2016-01-01'"</span>)</span>
<span id="cb24-137"><a href="#cb24-137" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb24-138"><a href="#cb24-138" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb24-139"><a href="#cb24-139" aria-hidden="true" tabindex="-1"></a>               columns<span class="op">=</span><span class="st">"name,start_time,min,max"</span>,</span>
<span id="cb24-140"><a href="#cb24-140" aria-hidden="true" tabindex="-1"></a>               where<span class="op">=</span><span class="st">"start_time &lt; '2016-01-01'"</span>)</span>
<span id="cb24-141"><a href="#cb24-141" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-142"><a href="#cb24-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-145"><a href="#cb24-145" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-146"><a href="#cb24-146" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the two time series for the city of Trento</span></span>
<span id="cb24-147"><a href="#cb24-147" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>g.gui.tplot strds<span class="op">=</span>lst_monthly,lst_monthly_copy <span class="op">\</span></span>
<span id="cb24-148"><a href="#cb24-148" aria-hidden="true" tabindex="-1"></a>  coordinates<span class="op">=</span><span class="fl">4410837.455830389</span>,<span class="fl">2559852.473498233</span> <span class="op">\</span></span>
<span id="cb24-149"><a href="#cb24-149" aria-hidden="true" tabindex="-1"></a>  title<span class="op">=</span><span class="st">"Trento daily LST"</span> xlabel<span class="op">=</span><span class="st">"Time"</span> ylabel<span class="op">=</span><span class="st">"LST (C)"</span> \</span>
<span id="cb24-150"><a href="#cb24-150" aria-hidden="true" tabindex="-1"></a>  size<span class="op">=</span><span class="dv">800</span>,<span class="dv">500</span> output<span class="op">=</span>trento_gapfilled.png</span>
<span id="cb24-151"><a href="#cb24-151" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-152"><a href="#cb24-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-153"><a href="#cb24-153" aria-hidden="true" tabindex="-1"></a><span class="al">![Linear interpolation of LST time series](img/trento_gapfilled.png)</span></span>
<span id="cb24-154"><a href="#cb24-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-155"><a href="#cb24-155" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-156"><a href="#cb24-156" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">t.unregister</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/t.unregister.html)</span> </span>
<span id="cb24-157"><a href="#cb24-157" aria-hidden="true" tabindex="-1"></a>allows us to remove maps from the temporal database or from </span>
<span id="cb24-158"><a href="#cb24-158" aria-hidden="true" tabindex="-1"></a>a STRDS without actually removing them from the mapset, i.e., we only remove</span>
<span id="cb24-159"><a href="#cb24-159" aria-hidden="true" tabindex="-1"></a>their timestamp and hence their record in the STRDS object.</span>
<span id="cb24-160"><a href="#cb24-160" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-161"><a href="#cb24-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-162"><a href="#cb24-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-163"><a href="#cb24-163" aria-hidden="true" tabindex="-1"></a><span class="fu">## Maps with holes</span></span>
<span id="cb24-164"><a href="#cb24-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-165"><a href="#cb24-165" aria-hidden="true" tabindex="-1"></a>For the case when maps have no data areas (i.e. holes or gaps) because of cloud</span>
<span id="cb24-166"><a href="#cb24-166" aria-hidden="true" tabindex="-1"></a>or cloud shadow masking, or as a result of QA flags application, two GRASS tools </span>
<span id="cb24-167"><a href="#cb24-167" aria-hidden="true" tabindex="-1"></a>can be used, namely </span>
<span id="cb24-168"><a href="#cb24-168" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">r.hants</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html)</span> or </span>
<span id="cb24-169"><a href="#cb24-169" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">r.series.lwr</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html)</span>. </span>
<span id="cb24-170"><a href="#cb24-170" aria-hidden="true" tabindex="-1"></a>When to use one or the other will mostly depend on the variable that the time</span>
<span id="cb24-171"><a href="#cb24-171" aria-hidden="true" tabindex="-1"></a>series represent (i.e., temperature, NDVI, chlorophyll, etc.) and its granularity</span>
<span id="cb24-172"><a href="#cb24-172" aria-hidden="true" tabindex="-1"></a>(i.e., hourly, daily, weekly, monthly, etc.). </span>
<span id="cb24-173"><a href="#cb24-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-174"><a href="#cb24-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-175"><a href="#cb24-175" aria-hidden="true" tabindex="-1"></a><span class="fu">### Simulating the holes</span></span>
<span id="cb24-176"><a href="#cb24-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-177"><a href="#cb24-177" aria-hidden="true" tabindex="-1"></a>To demonstrate the use of r.hants and r.series.lwr with our LST time series, we </span>
<span id="cb24-178"><a href="#cb24-178" aria-hidden="true" tabindex="-1"></a>will simulate the occurrence of clouds by randomly masking different </span>
<span id="cb24-179"><a href="#cb24-179" aria-hidden="true" tabindex="-1"></a>provinces in our study area. This will be a very simplified case only for </span>
<span id="cb24-180"><a href="#cb24-180" aria-hidden="true" tabindex="-1"></a>demonstration purposes. A proper example of how to mask clouds and apply quality</span>
<span id="cb24-181"><a href="#cb24-181" aria-hidden="true" tabindex="-1"></a>assessment flags will be developed in a different series of tutorials.</span>
<span id="cb24-182"><a href="#cb24-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-183"><a href="#cb24-183" aria-hidden="true" tabindex="-1"></a>We clip the provinces vector map with the computational region in order to</span>
<span id="cb24-184"><a href="#cb24-184" aria-hidden="true" tabindex="-1"></a>get the list of polygons' ids or cat values, that we'll use as *"clouds"*.</span>
<span id="cb24-185"><a href="#cb24-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-188"><a href="#cb24-188" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-189"><a href="#cb24-189" aria-hidden="true" tabindex="-1"></a><span class="co"># Clip Italy provinces to the comp region</span></span>
<span id="cb24-190"><a href="#cb24-190" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"v.clip"</span>,</span>
<span id="cb24-191"><a href="#cb24-191" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"italy_borders_2"</span>,</span>
<span id="cb24-192"><a href="#cb24-192" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"italy_borders_2_clip"</span>,</span>
<span id="cb24-193"><a href="#cb24-193" aria-hidden="true" tabindex="-1"></a>               flags<span class="op">=</span><span class="st">"r"</span>)</span>
<span id="cb24-194"><a href="#cb24-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-195"><a href="#cb24-195" aria-hidden="true" tabindex="-1"></a><span class="co"># Get unique categories </span></span>
<span id="cb24-196"><a href="#cb24-196" aria-hidden="true" tabindex="-1"></a>cats <span class="op">=</span> gs.parse_command(<span class="st">"v.category"</span>,</span>
<span id="cb24-197"><a href="#cb24-197" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">input</span><span class="op">=</span><span class="st">"italy_borders_2_clip"</span>, </span>
<span id="cb24-198"><a href="#cb24-198" aria-hidden="true" tabindex="-1"></a>                        option<span class="op">=</span><span class="st">"print"</span>)</span>
<span id="cb24-199"><a href="#cb24-199" aria-hidden="true" tabindex="-1"></a>                        </span>
<span id="cb24-200"><a href="#cb24-200" aria-hidden="true" tabindex="-1"></a>cats <span class="op">=</span> <span class="bu">list</span>(cats.keys())</span>
<span id="cb24-201"><a href="#cb24-201" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-202"><a href="#cb24-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-203"><a href="#cb24-203" aria-hidden="true" tabindex="-1"></a>Then we list the maps over which we will create the gaps.</span>
<span id="cb24-204"><a href="#cb24-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-207"><a href="#cb24-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-208"><a href="#cb24-208" aria-hidden="true" tabindex="-1"></a><span class="co"># Get list of monthly maps</span></span>
<span id="cb24-209"><a href="#cb24-209" aria-hidden="true" tabindex="-1"></a>maps <span class="op">=</span> gs.parse_command(<span class="st">"t.rast.list"</span>,</span>
<span id="cb24-210"><a href="#cb24-210" aria-hidden="true" tabindex="-1"></a>                         <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly"</span>,</span>
<span id="cb24-211"><a href="#cb24-211" aria-hidden="true" tabindex="-1"></a>                         columns<span class="op">=</span><span class="st">"name"</span>,</span>
<span id="cb24-212"><a href="#cb24-212" aria-hidden="true" tabindex="-1"></a>                         method<span class="op">=</span><span class="st">"comma"</span>,</span>
<span id="cb24-213"><a href="#cb24-213" aria-hidden="true" tabindex="-1"></a>                         flags<span class="op">=</span><span class="st">"u"</span>)</span>
<span id="cb24-214"><a href="#cb24-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-215"><a href="#cb24-215" aria-hidden="true" tabindex="-1"></a>maps <span class="op">=</span> <span class="bu">list</span>(maps.keys())</span>
<span id="cb24-216"><a href="#cb24-216" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-217"><a href="#cb24-217" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-218"><a href="#cb24-218" aria-hidden="true" tabindex="-1"></a>Finally, we actually use 4 random polygons to create holes in each map of the</span>
<span id="cb24-219"><a href="#cb24-219" aria-hidden="true" tabindex="-1"></a>monthly LST time series. Basically, for each map of the series, we apply an</span>
<span id="cb24-220"><a href="#cb24-220" aria-hidden="true" tabindex="-1"></a>inverse mask of 4 random polygons, we overwrite the maps to actually get the </span>
<span id="cb24-221"><a href="#cb24-221" aria-hidden="true" tabindex="-1"></a>holes (i.e., *MASK* is otherwise virtual), and we remove the mask.</span>
<span id="cb24-222"><a href="#cb24-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-225"><a href="#cb24-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-226"><a href="#cb24-226" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb24-227"><a href="#cb24-227" aria-hidden="true" tabindex="-1"></a>n<span class="op">=</span><span class="dv">4</span></span>
<span id="cb24-228"><a href="#cb24-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-229"><a href="#cb24-229" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(maps)):</span>
<span id="cb24-230"><a href="#cb24-230" aria-hidden="true" tabindex="-1"></a>    gs.run_command(<span class="st">"r.mask"</span>, </span>
<span id="cb24-231"><a href="#cb24-231" aria-hidden="true" tabindex="-1"></a>                   vector<span class="op">=</span><span class="st">"italy_borders_2_clip"</span>, </span>
<span id="cb24-232"><a href="#cb24-232" aria-hidden="true" tabindex="-1"></a>                   cats<span class="op">=</span>random.sample(cats,n), </span>
<span id="cb24-233"><a href="#cb24-233" aria-hidden="true" tabindex="-1"></a>                   flags<span class="op">=</span><span class="st">"i"</span>)</span>
<span id="cb24-234"><a href="#cb24-234" aria-hidden="true" tabindex="-1"></a>    gs.mapcalc(exp<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>maps[i]<span class="sc">}</span><span class="ss"> = </span><span class="sc">{</span>maps[i]<span class="sc">}</span><span class="ss">"</span>, </span>
<span id="cb24-235"><a href="#cb24-235" aria-hidden="true" tabindex="-1"></a>               overwrite<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb24-236"><a href="#cb24-236" aria-hidden="true" tabindex="-1"></a>    gs.run_command(<span class="st">"r.mask"</span>, </span>
<span id="cb24-237"><a href="#cb24-237" aria-hidden="true" tabindex="-1"></a>                   flags<span class="op">=</span><span class="st">"r"</span>)</span>
<span id="cb24-238"><a href="#cb24-238" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-239"><a href="#cb24-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-240"><a href="#cb24-240" aria-hidden="true" tabindex="-1"></a>Let's check the holes we created</span>
<span id="cb24-241"><a href="#cb24-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-244"><a href="#cb24-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-245"><a href="#cb24-245" aria-hidden="true" tabindex="-1"></a>gaps <span class="op">=</span> gj.Map(height <span class="op">=</span> <span class="dv">500</span>)</span>
<span id="cb24-246"><a href="#cb24-246" aria-hidden="true" tabindex="-1"></a>gaps.d_rast(<span class="bu">map</span><span class="op">=</span><span class="st">"lst_monthly_2017_01"</span>)</span>
<span id="cb24-247"><a href="#cb24-247" aria-hidden="true" tabindex="-1"></a>gaps.show()</span>
<span id="cb24-248"><a href="#cb24-248" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-249"><a href="#cb24-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-250"><a href="#cb24-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-251"><a href="#cb24-251" aria-hidden="true" tabindex="-1"></a><span class="fu">### Filling the holes </span></span>
<span id="cb24-252"><a href="#cb24-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-253"><a href="#cb24-253" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Harmonic analysis of time series</span></span>
<span id="cb24-254"><a href="#cb24-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-255"><a href="#cb24-255" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">r.hants</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html)</span> </span>
<span id="cb24-256"><a href="#cb24-256" aria-hidden="true" tabindex="-1"></a>performs a **Harmonic ANalysis of Time Series (HANTS)** analysis in order</span>
<span id="cb24-257"><a href="#cb24-257" aria-hidden="true" tabindex="-1"></a>to estimate missing values and identify outliers. </span>
<span id="cb24-258"><a href="#cb24-258" aria-hidden="true" tabindex="-1"></a>This algorithm considers only the most significant frequencies expected to be </span>
<span id="cb24-259"><a href="#cb24-259" aria-hidden="true" tabindex="-1"></a>present in the time profiles (e.g. determined from a preceding Fast Fourier </span>
<span id="cb24-260"><a href="#cb24-260" aria-hidden="true" tabindex="-1"></a>Transform analysis), and applies a least squares curve fitting procedure based </span>
<span id="cb24-261"><a href="#cb24-261" aria-hidden="true" tabindex="-1"></a>on harmonic components (sines and cosines).</span>
<span id="cb24-262"><a href="#cb24-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-263"><a href="#cb24-263" aria-hidden="true" tabindex="-1"></a>The option <span class="in">`nf`</span>, number of frequencies, should be carefully chosen. As a rule of </span>
<span id="cb24-264"><a href="#cb24-264" aria-hidden="true" tabindex="-1"></a>thumb, the nf should be at least the estimated periodicity plus 3, e.g. for </span>
<span id="cb24-265"><a href="#cb24-265" aria-hidden="true" tabindex="-1"></a>NDVI with an annual cycle (one peak per year), the number of</span>
<span id="cb24-266"><a href="#cb24-266" aria-hidden="true" tabindex="-1"></a>frequencies should be at least 4 when analyzing one year. </span>
<span id="cb24-267"><a href="#cb24-267" aria-hidden="true" tabindex="-1"></a>The number of frequencies should not be too large, either. Otherwise, </span>
<span id="cb24-268"><a href="#cb24-268" aria-hidden="true" tabindex="-1"></a>outliers can no longer be identified because of overfitting. </span>
<span id="cb24-269"><a href="#cb24-269" aria-hidden="true" tabindex="-1"></a>Moreover, the number of frequencies should be smaller than n input maps / 2 if </span>
<span id="cb24-270"><a href="#cb24-270" aria-hidden="true" tabindex="-1"></a>missing values should be reconstructed.</span>
<span id="cb24-271"><a href="#cb24-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-274"><a href="#cb24-274" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-275"><a href="#cb24-275" aria-hidden="true" tabindex="-1"></a><span class="co"># Install extension</span></span>
<span id="cb24-276"><a href="#cb24-276" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"g.extension"</span>,</span>
<span id="cb24-277"><a href="#cb24-277" aria-hidden="true" tabindex="-1"></a>               extension<span class="op">=</span><span class="st">"r.hants"</span>)</span>
<span id="cb24-278"><a href="#cb24-278" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-279"><a href="#cb24-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-282"><a href="#cb24-282" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-283"><a href="#cb24-283" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic usage of r.hants</span></span>
<span id="cb24-284"><a href="#cb24-284" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"r.hants"</span>,</span>
<span id="cb24-285"><a href="#cb24-285" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span>maps,</span>
<span id="cb24-286"><a href="#cb24-286" aria-hidden="true" tabindex="-1"></a>               nf<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb24-287"><a href="#cb24-287" aria-hidden="true" tabindex="-1"></a>               base_period<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb24-288"><a href="#cb24-288" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-289"><a href="#cb24-289" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-290"><a href="#cb24-290" aria-hidden="true" tabindex="-1"></a>:::{.callout-notes}</span>
<span id="cb24-291"><a href="#cb24-291" aria-hidden="true" tabindex="-1"></a>Other *r.hants* options and flags that can be used to adjust the fit can be found</span>
<span id="cb24-292"><a href="#cb24-292" aria-hidden="true" tabindex="-1"></a>at the tool manual page: </span>
<span id="cb24-293"><a href="#cb24-293" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;https://grass.osgeo.org/grass-stable/manuals/addons/r.hants.html&gt;</span> </span>
<span id="cb24-294"><a href="#cb24-294" aria-hidden="true" tabindex="-1"></a>and also within the </span>
<span id="cb24-295"><a href="#cb24-295" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">original publication</span><span class="co">](https://www.tandfonline.com/doi/abs/10.1080/014311600209814)</span>.</span>
<span id="cb24-296"><a href="#cb24-296" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-297"><a href="#cb24-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-300"><a href="#cb24-300" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-301"><a href="#cb24-301" aria-hidden="true" tabindex="-1"></a><span class="co"># List filled maps</span></span>
<span id="cb24-302"><a href="#cb24-302" aria-hidden="true" tabindex="-1"></a>hants_maps <span class="op">=</span> gs.list_grouped(<span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>, </span>
<span id="cb24-303"><a href="#cb24-303" aria-hidden="true" tabindex="-1"></a>                             pattern<span class="op">=</span><span class="st">"*hants"</span>)[<span class="st">"italy_LST_daily"</span>]</span>
<span id="cb24-304"><a href="#cb24-304" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-305"><a href="#cb24-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-308"><a href="#cb24-308" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-309"><a href="#cb24-309" aria-hidden="true" tabindex="-1"></a><span class="co"># Ccreate new time series </span></span>
<span id="cb24-310"><a href="#cb24-310" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.create"</span>,</span>
<span id="cb24-311"><a href="#cb24-311" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly_hants"</span>,</span>
<span id="cb24-312"><a href="#cb24-312" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"strds"</span>,</span>
<span id="cb24-313"><a href="#cb24-313" aria-hidden="true" tabindex="-1"></a>               temporaltype<span class="op">=</span><span class="st">"absolute"</span>,</span>
<span id="cb24-314"><a href="#cb24-314" aria-hidden="true" tabindex="-1"></a>               title<span class="op">=</span><span class="st">"Gap-filled monthly LST"</span>,</span>
<span id="cb24-315"><a href="#cb24-315" aria-hidden="true" tabindex="-1"></a>               description<span class="op">=</span><span class="st">"HANTS gap-filled monthly LST - North Italy, 2014-2018"</span>)</span>
<span id="cb24-316"><a href="#cb24-316" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-317"><a href="#cb24-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-320"><a href="#cb24-320" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-321"><a href="#cb24-321" aria-hidden="true" tabindex="-1"></a><span class="co"># register maps</span></span>
<span id="cb24-322"><a href="#cb24-322" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.register"</span>,</span>
<span id="cb24-323"><a href="#cb24-323" aria-hidden="true" tabindex="-1"></a>               flags<span class="op">=</span><span class="st">"i"</span>,</span>
<span id="cb24-324"><a href="#cb24-324" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_hants"</span>,</span>
<span id="cb24-325"><a href="#cb24-325" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>,</span>
<span id="cb24-326"><a href="#cb24-326" aria-hidden="true" tabindex="-1"></a>               maps<span class="op">=</span>hants_maps,</span>
<span id="cb24-327"><a href="#cb24-327" aria-hidden="true" tabindex="-1"></a>               start<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb24-328"><a href="#cb24-328" aria-hidden="true" tabindex="-1"></a>               increment<span class="op">=</span><span class="st">"1 months"</span>)</span>
<span id="cb24-329"><a href="#cb24-329" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-330"><a href="#cb24-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-333"><a href="#cb24-333" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-334"><a href="#cb24-334" aria-hidden="true" tabindex="-1"></a><span class="co"># Print time series info</span></span>
<span id="cb24-335"><a href="#cb24-335" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gs.read_command(<span class="st">"t.info"</span>, </span>
<span id="cb24-336"><a href="#cb24-336" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_hants"</span>))</span>
<span id="cb24-337"><a href="#cb24-337" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-338"><a href="#cb24-338" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-339"><a href="#cb24-339" aria-hidden="true" tabindex="-1"></a>Let's see a plot.</span>
<span id="cb24-340"><a href="#cb24-340" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-343"><a href="#cb24-343" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-344"><a href="#cb24-344" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>g.gui.tplot strds<span class="op">=</span>lst_monthly_hants,lst_monthly <span class="op">\</span></span>
<span id="cb24-345"><a href="#cb24-345" aria-hidden="true" tabindex="-1"></a>  coordinates<span class="op">=</span><span class="fl">4410837.455830389</span>,<span class="fl">2559852.473498233</span> <span class="op">\</span></span>
<span id="cb24-346"><a href="#cb24-346" aria-hidden="true" tabindex="-1"></a>  title<span class="op">=</span><span class="st">"Trento reconstructed LST"</span> xlabel<span class="op">=</span><span class="st">"Time"</span> ylabel<span class="op">=</span><span class="st">"LST (C)"</span> \</span>
<span id="cb24-347"><a href="#cb24-347" aria-hidden="true" tabindex="-1"></a>  size<span class="op">=</span><span class="dv">800</span>,<span class="dv">500</span> output<span class="op">=</span>trento_hants.png</span>
<span id="cb24-348"><a href="#cb24-348" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-349"><a href="#cb24-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-350"><a href="#cb24-350" aria-hidden="true" tabindex="-1"></a><span class="al">![HANTS interpolation of LST time series](img/trento_hants.png)</span></span>
<span id="cb24-351"><a href="#cb24-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-352"><a href="#cb24-352" aria-hidden="true" tabindex="-1"></a>Something important to highlight is that *r.hants* will fit a single model to</span>
<span id="cb24-353"><a href="#cb24-353" aria-hidden="true" tabindex="-1"></a>the whole input time series. For multiple years, that might not be the best</span>
<span id="cb24-354"><a href="#cb24-354" aria-hidden="true" tabindex="-1"></a>option because there won't be any variation. So, for the case of multiple years,</span>
<span id="cb24-355"><a href="#cb24-355" aria-hidden="true" tabindex="-1"></a>it is recommended to do multiple runs and then temporally patch the results. </span>
<span id="cb24-356"><a href="#cb24-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-357"><a href="#cb24-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-358"><a href="#cb24-358" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-359"><a href="#cb24-359" aria-hidden="true" tabindex="-1"></a>*r.hants* will reconstruct all cells within the input maps, whether they have gaps</span>
<span id="cb24-360"><a href="#cb24-360" aria-hidden="true" tabindex="-1"></a>or not. If we want to keep the original values, we could patch the original </span>
<span id="cb24-361"><a href="#cb24-361" aria-hidden="true" tabindex="-1"></a>series with the reconstructed result. That could be done as follows:</span>
<span id="cb24-362"><a href="#cb24-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-365"><a href="#cb24-365" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-366"><a href="#cb24-366" aria-hidden="true" tabindex="-1"></a><span class="co"># Patching</span></span>
<span id="cb24-367"><a href="#cb24-367" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i,j <span class="kw">in</span> <span class="bu">zip</span>(maps,hants_maps):</span>
<span id="cb24-368"><a href="#cb24-368" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(i, j)</span>
<span id="cb24-369"><a href="#cb24-369" aria-hidden="true" tabindex="-1"></a>    out<span class="op">=</span><span class="ss">f"</span><span class="sc">{</span>j<span class="sc">}</span><span class="ss">_patch"</span></span>
<span id="cb24-370"><a href="#cb24-370" aria-hidden="true" tabindex="-1"></a>    gs.run_command(<span class="st">"r.patch"</span>,</span>
<span id="cb24-371"><a href="#cb24-371" aria-hidden="true" tabindex="-1"></a>                   <span class="bu">input</span><span class="op">=</span>[i, j],</span>
<span id="cb24-372"><a href="#cb24-372" aria-hidden="true" tabindex="-1"></a>                   output<span class="op">=</span>out)</span>
<span id="cb24-373"><a href="#cb24-373" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-374"><a href="#cb24-374" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-375"><a href="#cb24-375" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-376"><a href="#cb24-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-377"><a href="#cb24-377" aria-hidden="true" tabindex="-1"></a><span class="fu">#### Local weighted regression</span></span>
<span id="cb24-378"><a href="#cb24-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-379"><a href="#cb24-379" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">r.series.lwr</span><span class="co">](https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html)</span></span>
<span id="cb24-380"><a href="#cb24-380" aria-hidden="true" tabindex="-1"></a>performs a local weighted regression (LWR) in time in order to estimate missing</span>
<span id="cb24-381"><a href="#cb24-381" aria-hidden="true" tabindex="-1"></a>values and identify outliers.</span>
<span id="cb24-382"><a href="#cb24-382" aria-hidden="true" tabindex="-1"></a>For each observation in the time series, the neighbor values in time are used </span>
<span id="cb24-383"><a href="#cb24-383" aria-hidden="true" tabindex="-1"></a>to estimate a polynomial function that best fits the observations. The values </span>
<span id="cb24-384"><a href="#cb24-384" aria-hidden="true" tabindex="-1"></a>are weighted according to their distance in time to the current observation. </span>
<span id="cb24-385"><a href="#cb24-385" aria-hidden="true" tabindex="-1"></a>Values that are farther away get lower weights. The difference among the weight</span>
<span id="cb24-386"><a href="#cb24-386" aria-hidden="true" tabindex="-1"></a>functions lies in how strongly the current observation is emphasized with </span>
<span id="cb24-387"><a href="#cb24-387" aria-hidden="true" tabindex="-1"></a>respect to its temporal neighbors.</span>
<span id="cb24-388"><a href="#cb24-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-389"><a href="#cb24-389" aria-hidden="true" tabindex="-1"></a>The option order determines the order of the polynomial function used to fit the </span>
<span id="cb24-390"><a href="#cb24-390" aria-hidden="true" tabindex="-1"></a>observations. An order of 0 is a weighted average, an order of 1 is a linear </span>
<span id="cb24-391"><a href="#cb24-391" aria-hidden="true" tabindex="-1"></a>regression. Recommended is order=2.</span>
<span id="cb24-392"><a href="#cb24-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-393"><a href="#cb24-393" aria-hidden="true" tabindex="-1"></a>All gaps in the time series are by default interpolated, as long as the time </span>
<span id="cb24-394"><a href="#cb24-394" aria-hidden="true" tabindex="-1"></a>series contains sufficient non-NULL observations. Optionally, the maximum size </span>
<span id="cb24-395"><a href="#cb24-395" aria-hidden="true" tabindex="-1"></a>of gaps to be interpolated can be set with the maxgap option. </span>
<span id="cb24-396"><a href="#cb24-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-397"><a href="#cb24-397" aria-hidden="true" tabindex="-1"></a>The module uses an adaptive bandwidth to fit the polynomial and searches for:</span>
<span id="cb24-398"><a href="#cb24-398" aria-hidden="true" tabindex="-1"></a>order + 1 + dod valid values around the current observation. The degree of </span>
<span id="cb24-399"><a href="#cb24-399" aria-hidden="true" tabindex="-1"></a>over-determination (dod) is the user defined number of extra temporal neighbors </span>
<span id="cb24-400"><a href="#cb24-400" aria-hidden="true" tabindex="-1"></a>that should be considered for the estimation of the value at each time step.</span>
<span id="cb24-401"><a href="#cb24-401" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-402"><a href="#cb24-402" aria-hidden="true" tabindex="-1"></a>Just for comparison purposes, we'll use the <span class="in">`lst_monthly`</span> time series. However,</span>
<span id="cb24-403"><a href="#cb24-403" aria-hidden="true" tabindex="-1"></a>r.series.lwr is known to be more effective when there's no such a clear cyclic</span>
<span id="cb24-404"><a href="#cb24-404" aria-hidden="true" tabindex="-1"></a>pattern or in smaller granularities, like daily or weekly, when data shows more</span>
<span id="cb24-405"><a href="#cb24-405" aria-hidden="true" tabindex="-1"></a>variation.</span>
<span id="cb24-406"><a href="#cb24-406" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-409"><a href="#cb24-409" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-410"><a href="#cb24-410" aria-hidden="true" tabindex="-1"></a><span class="co"># Install extension</span></span>
<span id="cb24-411"><a href="#cb24-411" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"g.extension"</span>,</span>
<span id="cb24-412"><a href="#cb24-412" aria-hidden="true" tabindex="-1"></a>               extension<span class="op">=</span><span class="st">"r.series.lwr"</span>)</span>
<span id="cb24-413"><a href="#cb24-413" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-414"><a href="#cb24-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-417"><a href="#cb24-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-418"><a href="#cb24-418" aria-hidden="true" tabindex="-1"></a><span class="co"># Run r.series.lwr</span></span>
<span id="cb24-419"><a href="#cb24-419" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"r.series.lwr"</span>,</span>
<span id="cb24-420"><a href="#cb24-420" aria-hidden="true" tabindex="-1"></a>                <span class="bu">input</span><span class="op">=</span>maps,</span>
<span id="cb24-421"><a href="#cb24-421" aria-hidden="true" tabindex="-1"></a>                suffix<span class="op">=</span><span class="st">"_lwr"</span>,</span>
<span id="cb24-422"><a href="#cb24-422" aria-hidden="true" tabindex="-1"></a>                order<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb24-423"><a href="#cb24-423" aria-hidden="true" tabindex="-1"></a>                weight<span class="op">=</span><span class="st">"tricube"</span>)</span>
<span id="cb24-424"><a href="#cb24-424" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-425"><a href="#cb24-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-426"><a href="#cb24-426" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-427"><a href="#cb24-427" aria-hidden="true" tabindex="-1"></a>Other *r.series.lwr* options and flags that can be used to adjust the fit can be found</span>
<span id="cb24-428"><a href="#cb24-428" aria-hidden="true" tabindex="-1"></a>at the tool manual page: </span>
<span id="cb24-429"><a href="#cb24-429" aria-hidden="true" tabindex="-1"></a><span class="ot">&lt;https://grass.osgeo.org/grass-stable/manuals/addons/r.series.lwr.html&gt;</span>. </span>
<span id="cb24-430"><a href="#cb24-430" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-431"><a href="#cb24-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-432"><a href="#cb24-432" aria-hidden="true" tabindex="-1"></a>Let's create a time series and plot the results.</span>
<span id="cb24-433"><a href="#cb24-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-436"><a href="#cb24-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-437"><a href="#cb24-437" aria-hidden="true" tabindex="-1"></a><span class="co"># List filled maps</span></span>
<span id="cb24-438"><a href="#cb24-438" aria-hidden="true" tabindex="-1"></a>lwr_maps <span class="op">=</span> gs.list_grouped(<span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>, </span>
<span id="cb24-439"><a href="#cb24-439" aria-hidden="true" tabindex="-1"></a>                           pattern<span class="op">=</span><span class="st">"*lwr"</span>)[<span class="st">"italy_LST_daily"</span>]</span>
<span id="cb24-440"><a href="#cb24-440" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-441"><a href="#cb24-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-444"><a href="#cb24-444" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-445"><a href="#cb24-445" aria-hidden="true" tabindex="-1"></a><span class="co"># Ccreate new time series </span></span>
<span id="cb24-446"><a href="#cb24-446" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.create"</span>,</span>
<span id="cb24-447"><a href="#cb24-447" aria-hidden="true" tabindex="-1"></a>               output<span class="op">=</span><span class="st">"lst_monthly_lwr"</span>,</span>
<span id="cb24-448"><a href="#cb24-448" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"strds"</span>,</span>
<span id="cb24-449"><a href="#cb24-449" aria-hidden="true" tabindex="-1"></a>               temporaltype<span class="op">=</span><span class="st">"absolute"</span>,</span>
<span id="cb24-450"><a href="#cb24-450" aria-hidden="true" tabindex="-1"></a>               title<span class="op">=</span><span class="st">"Gap-filled monthly LST"</span>,</span>
<span id="cb24-451"><a href="#cb24-451" aria-hidden="true" tabindex="-1"></a>               description<span class="op">=</span><span class="st">"LWR gap-filled monthly LST - North Italy, 2014-2018"</span>)</span>
<span id="cb24-452"><a href="#cb24-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-453"><a href="#cb24-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-456"><a href="#cb24-456" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-457"><a href="#cb24-457" aria-hidden="true" tabindex="-1"></a><span class="co"># register maps</span></span>
<span id="cb24-458"><a href="#cb24-458" aria-hidden="true" tabindex="-1"></a>gs.run_command(<span class="st">"t.register"</span>,</span>
<span id="cb24-459"><a href="#cb24-459" aria-hidden="true" tabindex="-1"></a>               flags<span class="op">=</span><span class="st">"i"</span>,</span>
<span id="cb24-460"><a href="#cb24-460" aria-hidden="true" tabindex="-1"></a>               <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_lwr"</span>,</span>
<span id="cb24-461"><a href="#cb24-461" aria-hidden="true" tabindex="-1"></a>               <span class="bu">type</span><span class="op">=</span><span class="st">"raster"</span>,</span>
<span id="cb24-462"><a href="#cb24-462" aria-hidden="true" tabindex="-1"></a>               maps<span class="op">=</span>lwr_maps,</span>
<span id="cb24-463"><a href="#cb24-463" aria-hidden="true" tabindex="-1"></a>               start<span class="op">=</span><span class="st">"2014-01-01"</span>,</span>
<span id="cb24-464"><a href="#cb24-464" aria-hidden="true" tabindex="-1"></a>               increment<span class="op">=</span><span class="st">"1 months"</span>)</span>
<span id="cb24-465"><a href="#cb24-465" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-466"><a href="#cb24-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-469"><a href="#cb24-469" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-470"><a href="#cb24-470" aria-hidden="true" tabindex="-1"></a><span class="co"># Print time series info</span></span>
<span id="cb24-471"><a href="#cb24-471" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(gs.read_command(<span class="st">"t.info"</span>, </span>
<span id="cb24-472"><a href="#cb24-472" aria-hidden="true" tabindex="-1"></a>                      <span class="bu">input</span><span class="op">=</span><span class="st">"lst_monthly_hants"</span>))</span>
<span id="cb24-473"><a href="#cb24-473" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-474"><a href="#cb24-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-477"><a href="#cb24-477" aria-hidden="true" tabindex="-1"></a><span class="in">```{python}</span></span>
<span id="cb24-478"><a href="#cb24-478" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>g.gui.tplot strds<span class="op">=</span>lst_monthly_lwr,lst_monthly <span class="op">\</span></span>
<span id="cb24-479"><a href="#cb24-479" aria-hidden="true" tabindex="-1"></a>  coordinates<span class="op">=</span><span class="fl">4410837.455830389</span>,<span class="fl">2559852.473498233</span> <span class="op">\</span></span>
<span id="cb24-480"><a href="#cb24-480" aria-hidden="true" tabindex="-1"></a>  title<span class="op">=</span><span class="st">"Trento reconstructed LST"</span> xlabel<span class="op">=</span><span class="st">"Time"</span> ylabel<span class="op">=</span><span class="st">"LST (C)"</span> \</span>
<span id="cb24-481"><a href="#cb24-481" aria-hidden="true" tabindex="-1"></a>  size<span class="op">=</span><span class="dv">800</span>,<span class="dv">500</span> output<span class="op">=</span>trento_lwr.png</span>
<span id="cb24-482"><a href="#cb24-482" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb24-483"><a href="#cb24-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-484"><a href="#cb24-484" aria-hidden="true" tabindex="-1"></a><span class="al">![LWR interpolation of LST time series](img/trento_lwr.png)</span></span>
<span id="cb24-485"><a href="#cb24-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-486"><a href="#cb24-486" aria-hidden="true" tabindex="-1"></a>:::{.callout-note}</span>
<span id="cb24-487"><a href="#cb24-487" aria-hidden="true" tabindex="-1"></a>Note that there's an overshoot towards negative values because of missing data </span>
<span id="cb24-488"><a href="#cb24-488" aria-hidden="true" tabindex="-1"></a>in the first date. Extrapolation can be avoided by using the <span class="in">`i`</span> flag for </span>
<span id="cb24-489"><a href="#cb24-489" aria-hidden="true" tabindex="-1"></a>*interpolation only*.</span>
<span id="cb24-490"><a href="#cb24-490" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb24-491"><a href="#cb24-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-492"><a href="#cb24-492" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-493"><a href="#cb24-493" aria-hidden="true" tabindex="-1"></a><span class="fu">### Comparison of r.hants and r.series.lwr results</span></span>
<span id="cb24-494"><a href="#cb24-494" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-495"><a href="#cb24-495" aria-hidden="true" tabindex="-1"></a>There are not so significant differences among the results of these two </span>
<span id="cb24-496"><a href="#cb24-496" aria-hidden="true" tabindex="-1"></a>reconstructing methods, probably because it is a smoothed time series. But</span>
<span id="cb24-497"><a href="#cb24-497" aria-hidden="true" tabindex="-1"></a>have a look at a comparison of applying HANTS and LWR to a Chlorophyll-a time</span>
<span id="cb24-498"><a href="#cb24-498" aria-hidden="true" tabindex="-1"></a>series with 8-day granularity:</span>
<span id="cb24-499"><a href="#cb24-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-500"><a href="#cb24-500" aria-hidden="true" tabindex="-1"></a><span class="al">![Chlorophyll data reconstruction with HANTS](https://grasswiki.osgeo.org/w/images/Cla_vs_cla_hants.png)</span>{width=80%}</span>
<span id="cb24-501"><a href="#cb24-501" aria-hidden="true" tabindex="-1"></a><span class="al">![Chlorophyll data reconstruction with LWR](https://grasswiki.osgeo.org/w/images/Cla_vs_cla_lwr.png)</span>{width=80%}</span>
<span id="cb24-502"><a href="#cb24-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-503"><a href="#cb24-503" aria-hidden="true" tabindex="-1"></a>More details can be found in the <span class="co">[</span><span class="ot">Filling and Reconstructing time series</span><span class="co">](https://grasswiki.osgeo.org/wiki/Temporal_data_processing#Filling_and_reconstructing_time_series_data_with_gaps)</span> of the temporal data processing wiki page.</span>
<span id="cb24-504"><a href="#cb24-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-505"><a href="#cb24-505" aria-hidden="true" tabindex="-1"></a><span class="fu">## References</span></span>
<span id="cb24-506"><a href="#cb24-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-507"><a href="#cb24-507" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Roerink, G., Menenti, M., Verhoef, W. 2000.</span>
<span id="cb24-508"><a href="#cb24-508" aria-hidden="true" tabindex="-1"></a>_Reconstructing cloudfree NDVI composites using Fourier analysis of time series._ </span>
<span id="cb24-509"><a href="#cb24-509" aria-hidden="true" tabindex="-1"></a>International Journal of Remote Sensing, 21 (9), 1911-1917. </span>
<span id="cb24-510"><a href="#cb24-510" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">DOI</span><span class="co">](http://dx.doi.org/10.1080/014311600209814)</span>.</span>
<span id="cb24-511"><a href="#cb24-511" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Gebbert, S., Pebesma, E. 2014.</span>
<span id="cb24-512"><a href="#cb24-512" aria-hidden="true" tabindex="-1"></a>_TGRASS: A temporal GIS for field based environmental modeling._</span>
<span id="cb24-513"><a href="#cb24-513" aria-hidden="true" tabindex="-1"></a>Environmental Modelling &amp; Software 53, 1-12. </span>
<span id="cb24-514"><a href="#cb24-514" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">DOI</span><span class="co">](http://dx.doi.org/10.1016/j.envsoft.2013.11.001)</span>.</span>
<span id="cb24-515"><a href="#cb24-515" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Gebbert, S., Pebesma, E. 2017. _The GRASS GIS temporal framework._</span>
<span id="cb24-516"><a href="#cb24-516" aria-hidden="true" tabindex="-1"></a>International Journal of Geographical Information Science 31, 1273-1292. </span>
<span id="cb24-517"><a href="#cb24-517" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">DOI</span><span class="co">](http://dx.doi.org/10.1080/13658816.2017.1306862)</span>.</span>
<span id="cb24-518"><a href="#cb24-518" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="co">[</span><span class="ot">Temporal data processing</span><span class="co">](https://grasswiki.osgeo.org/wiki/Temporal_data_processing)</span> wiki page.</span>
<span id="cb24-519"><a href="#cb24-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-520"><a href="#cb24-520" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-521"><a href="#cb24-521" aria-hidden="true" tabindex="-1"></a>***</span>
<span id="cb24-522"><a href="#cb24-522" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-523"><a href="#cb24-523" aria-hidden="true" tabindex="-1"></a>:::{.smaller}</span>
<span id="cb24-524"><a href="#cb24-524" aria-hidden="true" tabindex="-1"></a>The development of this tutorial was funded by the US </span>
<span id="cb24-525"><a href="#cb24-525" aria-hidden="true" tabindex="-1"></a><span class="co">[</span><span class="ot">National Science Foundation (NSF)</span><span class="co">](https://www.nsf.gov/)</span>, </span>
<span id="cb24-526"><a href="#cb24-526" aria-hidden="true" tabindex="-1"></a>award <span class="co">[</span><span class="ot">2303651</span><span class="co">](https://www.nsf.gov/awardsearch/showAward?AWD_ID=2303651)</span>.</span>
<span id="cb24-527"><a href="#cb24-527" aria-hidden="true" tabindex="-1"></a>:::</span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




</body></html>